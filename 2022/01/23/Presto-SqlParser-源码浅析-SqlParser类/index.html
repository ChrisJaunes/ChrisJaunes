<!DOCTYPE html>
<html lang="en" >
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<meta name="description" content="欢迎来的ChrisJaunes的世界">
	<meta name="keywords" content="chrisjaunes">
	<title>Presto-SqlParser源码浅析-SqlParser类 - ChrisJaunes</title>
	
	<link rel="shortcut icon" href="/ChrisJaunes/imgs/avatar.jpg"/>
	
<link rel="stylesheet" href="/ChrisJaunes/css/style.css">

	
<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<meta name="generator" content="Hexo 5.3.0"></head>
<body>
	<div class="main-con">
<nav class="nav cl">
    <ul class="cl nav-list">
        <li>
            <a href="/ChrisJaunes/" class="">
                <i class="fa fa-home"></i> 
                <span>主页</span>
            </a>
        </li>
        <li>
            <a href="/ChrisJaunes/archives/" class="">
                <i class=" fa-"></i> 
                <span>归档</span>
            </a>
        </li>
        <li>
            <a href="javascript:void(0)" class="">
                <i class=" fa-"></i> 
                <span>关于</span>
                <span class="drop-flag fa fa-angle-down"></span>
            </a>
            <dl>
                <li>
                    <a href="/ChrisJaunes/about" class="">
                    <i class=" fa-"></i>
                    <span>关于本站</span>
                    </a>
                </li>
            </dl>
        </li>
    </ul>
    <ul class="cl nav-tool">
        <li>
            <a target="_blank" rel="noopener" href="https://github.com/ChrisJaunes">
                <i class="fa fa-github"></i>
            </a>
        </li>
        <li>
            <a href="mailto:judgehuang@tencent.com">
                <i class="fa fa-envelope"></i>
            </a>
        </li>
        <li>
            <a href="javascript:void(0)" class="nav-search-btn">
                <i class="fa fa-search"></i>
            </a>
        </li>
    </ul>
    <form action="//google.com/search" method="get" accept-charset="UTF-8" class="nav-search"><input type="search" name="q" class="nav-search-input" placeholder="search..."><input type="hidden" name="sitesearch" value="https://chrisjaunes.github.io"></form>
</nav>

        
<div class="con-wrap fadeToTop">
    <section class="article-area">
        
<article class="article">
    <div class="article-wrap">
        <h2 class="article-title cl">
            <a href="/ChrisJaunes/2022/01/23/Presto-SqlParser-%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90-SqlParser%E7%B1%BB/" title="Presto-SqlParser源码浅析-SqlParser类">
                Presto-SqlParser源码浅析-SqlParser类
            </a>
        </h2>
        <ul class="article-extra" style="margin-bottom: 20px">
            <li class="article-time">
                2022-01-23
            </li> 
            <li class="article-category">
                <ol class="category-list cl">
                    <i class="fa fa-folder-o"></i>
                        <li><a href="/categories/Presto/">Presto</a></li>
                </ol>
            </li>
        </ul>
        <div class="article-description">
            <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1><span id="sqlparser-lei-qian-xi">SqlParser类 浅析</span><a href="#sqlparser-lei-qian-xi" class="header-anchor"> </a></h1>
<p>解析DSL需要以下步骤</p>
<img src="/ChrisJaunes/2022/01/23/Presto-SqlParser-%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90-SqlParser%E7%B1%BB/parser-steps.svg" class title="[parser-steps]">
<p>presto 解析 SQL 所用的工具 为 Antlr， 利用Antlr产生的Lexer和Parser进行SQL解析则是由 SqlParser 管理，主要是在 invokeParser 中 进行</p>
<hr>
<p>首先 将要解析的 sql 从 String 转成 CharStreams</p>
<p>考虑到 SQL 大小写不敏感，因此将字符流转成不区分大小写的字符流。 CaseInsensitiveStream 采用了代理模式，并在 LA方法中添加了 将所有的字符变成了大写 的逻辑。</p>
<p>这样就得到了词法分析器需要的字符流</p>
<div class="spoiler collapsed">
    <div class="spoiler-title">
        CaseInsensitiveStream 源码
    </div>
    <div class="spoiler-content">
        <pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CaseInsensitiveStream</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CharStream</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CharStream stream;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CaseInsensitiveStream</span><span class="hljs-params">(CharStream stream)</span> </span>&#123; <span class="hljs-keyword">this</span>.stream = stream; &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getText</span><span class="hljs-params">(Interval interval)</span> </span>&#123; <span class="hljs-keyword">return</span> stream.getText(interval); &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">consume</span><span class="hljs-params">()</span> </span>&#123; stream.consume(); &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">LA</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>&#123;
        <span class="hljs-keyword">int</span> result = stream.LA(i);
        <span class="hljs-keyword">switch</span> (result) &#123;
            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
            <span class="hljs-keyword">case</span> IntStream.EOF:
                <span class="hljs-keyword">return</span> result;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> Character.toUpperCase(result);
        &#125;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">mark</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> stream.mark(); &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">release</span><span class="hljs-params">(<span class="hljs-keyword">int</span> marker)</span> </span>&#123; stream.release(marker); &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">index</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> stream.index(); &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">seek</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index)</span> </span>&#123; stream.seek(index); &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> stream.size(); &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getSourceName</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> stream.getSourceName(); &#125;
&#125;</code></pre>
    </div>
</div>
<hr>
<p>接着 将字符流送入词法分析器</p>
<p>SqlBaseLexer 是Antlr根据<a target="_blank" rel="noopener" href="https://github.com/prestodb/presto/blob/master/presto-parser/src/main/antlr4/com/facebook/presto/sql/parser/SqlBase.g4">sqlbase.g4</a>生成的词法分析器，继承<a target="_blank" rel="noopener" href="https://github.com/antlr/antlr4/blob/master/runtime/Java/src/org/antlr/v4/runtime/Lexer.java">Lexer</a>，间接继承了<a target="_blank" rel="noopener" href="https://github.com/antlr/antlr4/blob/master/runtime/Java/src/org/antlr/v4/runtime/Recognizer.java">Recognizer&lt;Integer, LexerATNSimulator&gt;</a>， 而 <a target="_blank" rel="noopener" href="https://github.com/antlr/antlr4/blob/master/runtime/Java/src/org/antlr/v4/runtime/Recognizer.java">Recognizer&lt;Integer, LexerATNSimulator&gt;</a> 实现了<a target="_blank" rel="noopener" href="https://github.com/antlr/antlr4/blob/master/runtime/Java/src/org/antlr/v4/runtime/TokenSource.java">TokenSource</a></p>
<hr>
<p>经过词法分析器以后，产生符号流。 由于 SqlBaseLexer 实现了 TokenSource， 因此可以转成 <a target="_blank" rel="noopener" href="https://github.com/antlr/antlr4/blob/master/runtime/Java/src/org/antlr/v4/runtime/CommonToken.java">CommonTokenStream</a></p>
<hr>
<p>接着 将符号流送入语法分析器</p>
<p>SqlBaseParser 是Antlr根据<a target="_blank" rel="noopener" href="https://github.com/prestodb/presto/blob/master/presto-parser/src/main/antlr4/com/facebook/presto/sql/parser/SqlBase.g4">sqlbase.g4</a>生成的语法分析器，继承<a target="_blank" rel="noopener" href="https://github.com/antlr/antlr4/blob/master/runtime/Java/src/org/antlr/v4/runtime/Parser.java">Parser</a>，间接继承了<a target="_blank" rel="noopener" href="https://github.com/antlr/antlr4/blob/master/runtime/Java/src/org/antlr/v4/runtime/Recognizer.java">Recognizer&lt;Integer, LexerATNSimulator&gt;</a></p>
<hr>
<p>为了允许用户对于词法分析器和语法分析器做自定义的处理，initializer接受词法分析器对象和语法分析器对象并对其操作，默认情况下是不进行任何操作</p>
<div class="spoiler collapsed">
    <div class="spoiler-title">
        SqlParser initializer 相关源码
    </div>
    <div class="spoiler-content">
        <pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqlParser</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> BiConsumer&lt;SqlBaseLexer, SqlBaseParser&gt; DEFAULT_PARSER_INITIALIZER = (SqlBaseLexer lexer, SqlBaseParser parser) -&gt; &#123;&#125;;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BiConsumer&lt;SqlBaseLexer, SqlBaseParser&gt; initializer;
    
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SqlParser</span><span class="hljs-params">(SqlParserOptions options)</span> </span>&#123; <span class="hljs-keyword">this</span>(options, DEFAULT_PARSER_INITIALIZER); &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SqlParser</span><span class="hljs-params">(SqlParserOptions options, BiConsumer&lt;SqlBaseLexer, SqlBaseParser&gt; initializer)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.initializer = requireNonNull(initializer, <span class="hljs-string">&quot;initializer is null&quot;</span>);
        ...
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">private</span> Node <span class="hljs-title">invokeParser</span><span class="hljs-params">(String name, String sql, Function&lt;SqlBaseParser, ParserRuleContext&gt; parseFunction, ParsingOptions parsingOptions)</span> </span>&#123;
        ...
        initializer.accept(lexer, parser);
        ...
    &#125;
    ...
&#125;</code></pre>
    </div>
</div>
<hr>
<p>Parser注册了 PostProcessor 对象 作为其 Listener, PostProcessor 继承于 SqlBaseBaseListener(由Antlr生成)，SqlBaseBaseListener 实现了 SqlBaseListener 接口</p>
<p>SqlBaseBaseListener 对语法树节点都提供了 enterXXX 和 exitXXX，不过这些默认都是空方法，也就是SqlBaseBaseListener其实什么都没有干</p>
<p>PostProcessor 重写了exitUnquotedIdentifier、exitBackQuotedIdentifier、exitDigitIdentifier、exitNonReserved 四个方法</p>
<ol>
<li>
<p>exitUnquotedIdentifier 方法处理不带引号的标识符，当标识符存在不合法符号的时候抛出异常</p>
<ul>
<li>
<p>不合法符号由EnumSet.complementOf(allowedIdentifierSymbols)确定</p>
</li>
<li>
<p>allowedIdentifierSymbols 在 构造函数 中初始化，并且使用final禁止改变该变量的引用</p>
</li>
<li>
<p>例如 select * from foo@bar 存在不合法符号 @，由此抛出“line 1:15: identifiers must not contain ‘@’”</p>
</li>
</ul>
</li>
<li>
<p>exitBackQuotedIdentifier 方法处理反引号包裹的标识符，当存在反引号的时候抛出异常</p>
<ul>
<li>
<p>标准的Presto是不能使用反引号的</p>
</li>
<li>
<p>例如 select * from `foo` 存在反引号，由此抛出“line 1:15: backquoted identifiers are not supported; use double quotes to quote identifiers”</p>
</li>
</ul>
</li>
<li>
<p>exitDigitIdentifier 方法处理数字开头的标识符</p>
<ul>
<li>例如 select 1x from dual 存在不合法的1X， 由此抛出“line 1:8: identifiers must not start with a digit; surround the identifier with double quotes”</li>
</ul>
</li>
<li>
<p>exitNonReserved 处理 NonReserved</p>
<ul>
<li>
<p>要求是叶子节点(TerminalNode)</p>
</li>
<li>
<p>用 IDENT 标记替换 nonReserved 标记</p>
</li>
<li>
<p>例如 select if(1=1,1,0) from foo 中的 if ，原本if的type类型是 SqlBaseLexer.IF (数值85)， 现改为 SqlBaseLexer.IDENTIFIER (数值231)</p>
</li>
</ul>
</li>
</ol>
<div class="spoiler collapsed">
    <div class="spoiler-title">
        PostProcessor 源码
    </div>
    <div class="spoiler-content">
        <pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqlParser</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EnumSet&lt;IdentifierSymbol&gt; allowedIdentifierSymbols;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SqlParser</span><span class="hljs-params">(SqlParserOptions options, BiConsumer&lt;SqlBaseLexer, SqlBaseParser&gt; initializer)</span> </span>&#123;
        allowedIdentifierSymbols = EnumSet.copyOf(options.getAllowedIdentifierSymbols());
        ...
    &#125;

    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SqlBaseBaseListener</span> </span>&#123;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;String&gt; ruleNames;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Consumer&lt;ParsingWarning&gt; warningConsumer;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PostProcessor</span><span class="hljs-params">(List&lt;String&gt; ruleNames, Consumer&lt;ParsingWarning&gt; warningConsumer)</span> </span>&#123;
            <span class="hljs-keyword">this</span>.ruleNames = ruleNames;
            <span class="hljs-keyword">this</span>.warningConsumer = requireNonNull(warningConsumer, <span class="hljs-string">&quot;warningConsumer is null&quot;</span>);
        &#125;

        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exitUnquotedIdentifier</span><span class="hljs-params">(SqlBaseParser.UnquotedIdentifierContext context)</span> </span>&#123;
            String identifier = context.IDENTIFIER().getText();
            <span class="hljs-keyword">for</span> (IdentifierSymbol identifierSymbol : EnumSet.complementOf(allowedIdentifierSymbols)) &#123;
                <span class="hljs-keyword">char</span> symbol = identifierSymbol.getSymbol();
                <span class="hljs-keyword">if</span> (identifier.indexOf(symbol) &gt;= <span class="hljs-number">0</span>) &#123;
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParsingException(<span class="hljs-string">&quot;identifiers must not contain &#x27;&quot;</span> + identifierSymbol.getSymbol() + <span class="hljs-string">&quot;&#x27;&quot;</span>, <span class="hljs-keyword">null</span>, context.IDENTIFIER().getSymbol().getLine(), context.IDENTIFIER().getSymbol().getCharPositionInLine());
                &#125;
            &#125;
        &#125;

        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exitBackQuotedIdentifier</span><span class="hljs-params">(SqlBaseParser.BackQuotedIdentifierContext context)</span> </span>&#123;
            Token token = context.BACKQUOTED_IDENTIFIER().getSymbol();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParsingException(
                    <span class="hljs-string">&quot;backquoted identifiers are not supported; use double quotes to quote identifiers&quot;</span>,
                    <span class="hljs-keyword">null</span>,
                    token.getLine(),
                    token.getCharPositionInLine());
        &#125;

        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exitDigitIdentifier</span><span class="hljs-params">(SqlBaseParser.DigitIdentifierContext context)</span> </span>&#123;
            Token token = context.DIGIT_IDENTIFIER().getSymbol();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParsingException(
                    <span class="hljs-string">&quot;identifiers must not start with a digit; surround the identifier with double quotes&quot;</span>,
                    <span class="hljs-keyword">null</span>,
                    token.getLine(),
                    token.getCharPositionInLine());
        &#125;

        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exitNonReserved</span><span class="hljs-params">(SqlBaseParser.NonReservedContext context)</span> </span>&#123;
            <span class="hljs-comment">// we can&#x27;t modify the tree during rule enter/exit event handling unless we&#x27;re dealing with a terminal.</span>
            <span class="hljs-comment">// Otherwise, ANTLR gets confused an fires spurious notifications.</span>
            <span class="hljs-keyword">if</span> (!(context.getChild(<span class="hljs-number">0</span>) <span class="hljs-keyword">instanceof</span> TerminalNode)) &#123;
                <span class="hljs-keyword">int</span> rule = ((ParserRuleContext) context.getChild(<span class="hljs-number">0</span>)).getRuleIndex();
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AssertionError(<span class="hljs-string">&quot;nonReserved can only contain tokens. Found nested rule: &quot;</span> + ruleNames.get(rule));
            &#125;

            <span class="hljs-comment">// replace nonReserved words with IDENT tokens</span>
            context.getParent().removeLastChild();

            Token token = (Token) context.getChild(<span class="hljs-number">0</span>).getPayload();
            <span class="hljs-keyword">if</span> (RESERVED_WORDS_WARNING.contains(token.getText().toUpperCase())) &#123;
                warningConsumer.accept(<span class="hljs-keyword">new</span> ParsingWarning(
                        format(<span class="hljs-string">&quot;%s should be a reserved word, please use double quote (\&quot;%s\&quot;). This will be made a reserved word in future release.&quot;</span>, token.getText(), token.getText()),
                        token.getLine(),
                        token.getCharPositionInLine()));
            &#125;

            context.getParent().addChild(<span class="hljs-keyword">new</span> CommonToken(
                    <span class="hljs-keyword">new</span> Pair&lt;&gt;(token.getTokenSource(), token.getInputStream()),
                    SqlBaseLexer.IDENTIFIER,
                    token.getChannel(),
                    token.getStartIndex(),
                    token.getStopIndex()));
        &#125;
    &#125;
    ...
&#125;</code></pre>
    </div>
</div>
<hr>
<p>当然 还为词法分析器和语法分析器添加了错误监听器，在添加错误监听之前移除了全部已有的错误监听器。</p>
<p>LEXER_ERROR_LISTENER 是一个 BaseErrorListener，提供了一个转换功能, 用于将 Antlr 的 syntaxError 转成 Presto 中的 ParsingException 并抛出。</p>
<p>PARSER_ERROR_HANDLER 是一个 ErrorHandler。ErrorHandler 从 BaseErrorListener 继承，并提供了<a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/builder">生成器</a>来构造ErrorHandler对象，可以针对 specialRules、 specialTokens、 ignoredRules 做出处理。PARSER_ERROR_HANDLER 处理的规则见代码。</p>
<p>用户可以根据enhancedErrorHandlerEnabled 为 parser 选择 添加 PARSER_ERROR_HANDLER 还是 LEXER_ERROR_LISTENER</p>
<p>还为语法分析器设置了错误处理策略，为了防止弄乱报告，重写了recoverInline方法。</p>
<div class="spoiler collapsed">
    <div class="spoiler-title">
        SqlParser ErrorHandler 相关源码
    </div>
    <div class="spoiler-content">
        <pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqlParser</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> BaseErrorListener LEXER_ERROR_LISTENER = <span class="hljs-keyword">new</span> BaseErrorListener() &#123;
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">syntaxError</span><span class="hljs-params">(Recognizer&lt;?, ?&gt; recognizer, Object offendingSymbol, <span class="hljs-keyword">int</span> line, <span class="hljs-keyword">int</span> charPositionInLine, String message, RecognitionException e)</span> </span>&#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParsingException(message, e, line, charPositionInLine);
        &#125;
    &#125;;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ErrorHandler PARSER_ERROR_HANDLER = ErrorHandler.builder()
            .specialRule(SqlBaseParser.RULE_expression, <span class="hljs-string">&quot;&lt;expression&gt;&quot;</span>)
            .specialRule(SqlBaseParser.RULE_booleanExpression, <span class="hljs-string">&quot;&lt;expression&gt;&quot;</span>)
            .specialRule(SqlBaseParser.RULE_valueExpression, <span class="hljs-string">&quot;&lt;expression&gt;&quot;</span>)
            .specialRule(SqlBaseParser.RULE_primaryExpression, <span class="hljs-string">&quot;&lt;expression&gt;&quot;</span>)
            .specialRule(SqlBaseParser.RULE_identifier, <span class="hljs-string">&quot;&lt;identifier&gt;&quot;</span>)
            .specialRule(SqlBaseParser.RULE_string, <span class="hljs-string">&quot;&lt;string&gt;&quot;</span>)
            .specialRule(SqlBaseParser.RULE_query, <span class="hljs-string">&quot;&lt;query&gt;&quot;</span>)
            .specialRule(SqlBaseParser.RULE_type, <span class="hljs-string">&quot;&lt;type&gt;&quot;</span>)
            .specialToken(SqlBaseLexer.INTEGER_VALUE, <span class="hljs-string">&quot;&lt;integer&gt;&quot;</span>)
            .ignoredRule(SqlBaseParser.RULE_nonReserved)
            .build();
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> enhancedErrorHandlerEnabled;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SqlParser</span><span class="hljs-params">(SqlParserOptions options, BiConsumer&lt;SqlBaseLexer, SqlBaseParser&gt; initializer)</span> </span>&#123;
        ...
        enhancedErrorHandlerEnabled = options.isEnhancedErrorHandlerEnabled();
    &#125;
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> Node <span class="hljs-title">invokeParser</span><span class="hljs-params">(String name, String sql, Function&lt;SqlBaseParser, ParserRuleContext&gt; parseFunction, ParsingOptions parsingOptions)</span> </span>&#123;
        ...
        <span class="hljs-comment">// Override the default error strategy to not attempt inserting or deleting a token.</span>
        <span class="hljs-comment">// Otherwise, it messes up error reporting</span>
        parser.setErrorHandler(<span class="hljs-keyword">new</span> DefaultErrorStrategy() &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> Token <span class="hljs-title">recoverInline</span><span class="hljs-params">(Parser recognizer)</span> <span class="hljs-keyword">throws</span> RecognitionException</span>&#123;
                <span class="hljs-keyword">if</span> (nextTokensContext == <span class="hljs-keyword">null</span>) &#123;
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InputMismatchException(recognizer);
                &#125; <span class="hljs-keyword">else</span> &#123;
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InputMismatchException(recognizer, nextTokensState, nextTokensContext);
                &#125;
            &#125;
        &#125;);
        lexer.removeErrorListeners();
        lexer.addErrorListener(LEXER_ERROR_LISTENER);
        parser.removeErrorListeners();
        <span class="hljs-keyword">if</span> (enhancedErrorHandlerEnabled) &#123;
            parser.addErrorListener(PARSER_ERROR_HANDLER);
        &#125; <span class="hljs-keyword">else</span> &#123;
            parser.addErrorListener(LEXER_ERROR_LISTENER);
        &#125;
        ...
    &#125;
    ...
&#125;</code></pre>
    </div>
</div>
<hr>
<p>设置 parser 的解析方法，首先尝试使用更快的SLL，如果失败采用LL</p>
<p>parseFunction 接受 parser，并返回语法树</p>
<p>关注到parseFunction的类型为Function&lt;SqlBaseParser, ParserRuleContext&gt;</p>
<p>主要是指定了文法规则入口</p>
<div class="spoiler collapsed">
    <div class="spoiler-title">
        SqlParser parseFunction 相关源码
    </div>
    <div class="spoiler-content">
        <pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqlParser</span></span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> Statement <span class="hljs-title">createStatement</span><span class="hljs-params">(String sql, ParsingOptions parsingOptions)</span> </span>&#123;
        <span class="hljs-keyword">return</span> (Statement) invokeParser(<span class="hljs-string">&quot;statement&quot;</span>, sql, SqlBaseParser::singleStatement, parsingOptions);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Expression <span class="hljs-title">createExpression</span><span class="hljs-params">(String expression, ParsingOptions parsingOptions)</span> </span>&#123;
        <span class="hljs-keyword">return</span> (Expression) invokeParser(<span class="hljs-string">&quot;expression&quot;</span>, expression, SqlBaseParser::standaloneExpression, parsingOptions);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Return <span class="hljs-title">createReturn</span><span class="hljs-params">(String routineBody, ParsingOptions parsingOptions)</span> </span>&#123;
        <span class="hljs-keyword">return</span> (Return) invokeParser(<span class="hljs-string">&quot;return&quot;</span>, routineBody, SqlBaseParser::standaloneRoutineBody, parsingOptions);
    &#125;

    ...
&#125;</code></pre>
    </div>
</div>
<hr>
<p>最后需要对于这颗语法树的所有元素进行某些处理，考虑到语法树是一个复杂的对象结构，Antlr允许使用<a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/visitor">访问者模式</a>。</p>
<p>使用AstBuilder对象对这颗语法树进行访问和处理。</p>
<hr>
<p>最后，当栈溢出(StackOverflowError)的时候, 抛出ParsingException。</p>
<hr>
<div class="spoiler collapsed">
    <div class="spoiler-title">
        SqlParser invokeParser 源码
    </div>
    <div class="spoiler-content">
        <pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqlParser</span></span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">private</span> Node <span class="hljs-title">invokeParser</span><span class="hljs-params">(String name, String sql, Function&lt;SqlBaseParser, ParserRuleContext&gt; parseFunction, ParsingOptions parsingOptions)</span> </span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            SqlBaseLexer lexer = <span class="hljs-keyword">new</span> SqlBaseLexer(<span class="hljs-keyword">new</span> CaseInsensitiveStream(CharStreams.fromString(sql)));
            CommonTokenStream tokenStream = <span class="hljs-keyword">new</span> CommonTokenStream(lexer);
            SqlBaseParser parser = <span class="hljs-keyword">new</span> SqlBaseParser(tokenStream);
            initializer.accept(lexer, parser);

            <span class="hljs-comment">// Override the default error strategy to not attempt inserting or deleting a token.</span>
            <span class="hljs-comment">// Otherwise, it messes up error reporting</span>
            parser.setErrorHandler(<span class="hljs-keyword">new</span> DefaultErrorStrategy() &#123;
                <span class="hljs-meta">@Override</span>
                <span class="hljs-function"><span class="hljs-keyword">public</span> Token <span class="hljs-title">recoverInline</span><span class="hljs-params">(Parser recognizer)</span> <span class="hljs-keyword">throws</span> RecognitionException </span>&#123;
                    <span class="hljs-keyword">if</span> (nextTokensContext == <span class="hljs-keyword">null</span>) &#123;
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InputMismatchException(recognizer);
                    &#125; <span class="hljs-keyword">else</span> &#123;
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InputMismatchException(recognizer, nextTokensState, nextTokensContext);
                    &#125;
                &#125;
            &#125;);

            parser.addParseListener(<span class="hljs-keyword">new</span> PostProcessor(Arrays.asList(parser.getRuleNames()), parsingOptions.getWarningConsumer()));

            lexer.removeErrorListeners();
            lexer.addErrorListener(LEXER_ERROR_LISTENER);

            parser.removeErrorListeners();

            <span class="hljs-keyword">if</span> (enhancedErrorHandlerEnabled) &#123;
                parser.addErrorListener(PARSER_ERROR_HANDLER);
            &#125; <span class="hljs-keyword">else</span> &#123;
                parser.addErrorListener(LEXER_ERROR_LISTENER);
            &#125;

            ParserRuleContext tree;
            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-comment">// first, try parsing with potentially faster SLL mode</span>
                parser.getInterpreter().setPredictionMode(PredictionMode.SLL);
                tree = parseFunction.apply(parser);
            &#125; <span class="hljs-keyword">catch</span> (ParseCancellationException ex) &#123;
                <span class="hljs-comment">// if we fail, parse with LL mode</span>
                tokenStream.reset(); <span class="hljs-comment">// rewind input stream</span>
                parser.reset();

                parser.getInterpreter().setPredictionMode(PredictionMode.LL);
                tree = parseFunction.apply(parser);
            &#125;

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AstBuilder(parsingOptions).visit(tree);
        &#125; <span class="hljs-keyword">catch</span> (StackOverflowError e) &#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParsingException(name + <span class="hljs-string">&quot; is too large (stack overflow while parsing)&quot;</span>);
        &#125;
    &#125;
&#125;</code></pre>
    </div>
</div>
<link rel="stylesheet" href="/ChrisJaunes/css/spoiler.css" type="text/css"><script src="/ChrisJaunes/js/spoiler.js" type="text/javascript" async></script>
        </div>
        <div class="article-tags">
            <ul class="tags-list cl">
                <li><a href="/ChrisJaunes/tags/Presto/"><i class="fa fa-tag"></i>Presto</a></li>
                <li><a href="/ChrisJaunes/tags/Sql%E8%A7%A3%E6%9E%90/"><i class="fa fa-tag"></i>Sql解析</a></li>
            </ul>
        </div>
        <div class="article-pagination cl">
            <div class="pagination-prev">
                <a href="/ChrisJaunes/2022/01/24/Presto-SqlParser-%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90-AstBuilder%E7%B1%BB/">上一篇：Presto-SqlParser-源码浅析-AstBuilder类</a>
            </div>
            <div class="pagination-next">
                <a href="/ChrisJaunes/2021/10/13/Python-%E6%96%87%E6%A1%A3%E5%AD%97%E7%AC%A6%E4%B8%B2/">下一篇：Python-文档字符串</a>
            </div>
        </div> 
        
            <link rel="stylesheet" href="https://unpkg.com/gitalk@latest/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
<script src="https://priesttomb.github.io/js/md5.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
    new Gitalk({
        clientID: '0ba2ec4192b1d2fb9cb6',
        clientSecret: '85deadc0e6ed5bdf825a822ab2fdfbad69401fb9',
        repo: 'ChrisJaunes',
        owner: 'ChrisJaunes',
        admin: 'ChrisJaunes',
        id: md5(location.pathname),
        distractionFreeMode: true,
        proxy: 'https://vercel.prohibitorum.top/github_access_token'
    }).render('gitalk-container')
</script>
        
    </div>

</article>
    </section>
        
<section class="tool-area">

    <div class="toolbar">
        

        
        <div class="widget-post widget" style="order: 1 ">
            <h2 class="widget-title"><i class="fa fa-file-text"></i> Recent articles</h2>
            <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/ChrisJaunes/2023/05/29/TaskFlow-%E7%AE%80%E4%BB%8B/">TaskFlow-简介</a></li><li class="post-list-item"><a class="post-list-link" href="/ChrisJaunes/2023/05/25/TaskFlow-%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90-Executor%E7%B1%BB/">TaskFlow-源码浅析-Executor类</a></li><li class="post-list-item"><a class="post-list-link" href="/ChrisJaunes/2023/02/20/python-mock-%E7%94%A8%E6%B3%95%E6%B5%85%E6%9E%90-%E6%9B%BF%E6%8D%A2%E8%A2%AB%E6%B5%8B%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9F%90%E4%BA%9B%E9%83%A8%E5%88%86/">python-mock-用法浅析-替换被测系统的某些部分</a></li><li class="post-list-item"><a class="post-list-link" href="/ChrisJaunes/2022/09/05/DRF-ModelSerializer-%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90-%E5%BA%8F%E5%88%97%E5%8C%96/">DRF-ModelSerializer-源码浅析-序列化</a></li><li class="post-list-item"><a class="post-list-link" href="/ChrisJaunes/2022/08/02/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95-mock%E6%B5%85%E6%9E%90-1-%E6%A6%82%E8%BF%B0/">单元测试-mock浅析-1-概述</a></li><li class="post-list-item"><a class="post-list-link" href="/ChrisJaunes/2022/04/26/ZooKeeper-%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E7%9B%B8%E5%85%B3/">ZooKeeper-源码浅析-数据模型相关</a></li><li class="post-list-item"><a class="post-list-link" href="/ChrisJaunes/2022/04/25/ZooKeeper-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/">ZooKeeper-数据模型</a></li><li class="post-list-item"><a class="post-list-link" href="/ChrisJaunes/2022/04/25/ZooKeeper-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">ZooKeeper-环境搭建</a></li></ul>
        </div>
        

        
        <div class="widget-tags widget" style="order: 2 ">
            <h2 class="widget-title"><i class="fa fa-tags"></i> Tag</h2>
            <a href="/ChrisJaunes/tags/Blockly/" style="font-size: 14px;">Blockly</a> <a href="/ChrisJaunes/tags/C/" style="font-size: 14px;">C++</a> <a href="/ChrisJaunes/tags/D3/" style="font-size: 10px;">D3</a> <a href="/ChrisJaunes/tags/Http/" style="font-size: 16px;">Http</a> <a href="/ChrisJaunes/tags/HttpServer/" style="font-size: 16px;">HttpServer</a> <a href="/ChrisJaunes/tags/Java/" style="font-size: 20px;">Java</a> <a href="/ChrisJaunes/tags/Jupyter/" style="font-size: 12px;">Jupyter</a> <a href="/ChrisJaunes/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/ChrisJaunes/tags/Mock/" style="font-size: 10px;">Mock</a> <a href="/ChrisJaunes/tags/Net/" style="font-size: 12px;">Net</a> <a href="/ChrisJaunes/tags/Presto/" style="font-size: 12px;">Presto</a> <a href="/ChrisJaunes/tags/Python/" style="font-size: 18px;">Python</a> <a href="/ChrisJaunes/tags/Servlet/" style="font-size: 12px;">Servlet</a> <a href="/ChrisJaunes/tags/Skulpt/" style="font-size: 10px;">Skulpt</a> <a href="/ChrisJaunes/tags/Sql%E8%A7%A3%E6%9E%90/" style="font-size: 12px;">Sql解析</a> <a href="/ChrisJaunes/tags/TaskFlow/" style="font-size: 12px;">TaskFlow</a> <a href="/ChrisJaunes/tags/TensorFlow/" style="font-size: 10px;">TensorFlow</a> <a href="/ChrisJaunes/tags/ZooKeeper/" style="font-size: 14px;">ZooKeeper</a> <a href="/ChrisJaunes/tags/container/" style="font-size: 10px;">container</a> <a href="/ChrisJaunes/tags/django/" style="font-size: 10px;">django</a> <a href="/ChrisJaunes/tags/metakernel/" style="font-size: 10px;">metakernel</a> <a href="/ChrisJaunes/tags/python/" style="font-size: 10px;">python</a> <a href="/ChrisJaunes/tags/test/" style="font-size: 10px;">test</a> <a href="/ChrisJaunes/tags/web/" style="font-size: 10px;">web</a> <a href="/ChrisJaunes/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 14px;">分布式</a> <a href="/ChrisJaunes/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">单元测试</a> <a href="/ChrisJaunes/tags/%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 10px;">序列化</a>
        </div>
        

        
            <div class="widget-categories widget" style="order: 3 ">
                <h2 class="widget-title"><i class="fa fa-folder-open"></i> Categories</h2>
                 <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Blockly/">Blockly</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Blockly/BlocklyJupyter/">BlocklyJupyter</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/C/">C++</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/C/%E6%A0%87%E5%87%86%E5%BA%93/">标准库</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/D3/">D3</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Java/">Java</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Java/Http/">Http</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Java/Http/HttpServer/">HttpServer</a><span class="category-list-count">4</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Java/Servlet/">Servlet</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Presto/">Presto</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Presto/SqlParser/">SqlParser</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Python/">Python</a><span class="category-list-count">5</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Python/Docx/">Docx</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Python/Json/">Json</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Python/Mock/">Mock</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Python/%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0/">内置函数</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/Skulpt/">Skulpt</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/TaskFlow/">TaskFlow</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/TensorFlow/">TensorFlow</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/TensorFlow/env/">env</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/django/">django</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/programing-language/">programing_language</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/programing-language/%E6%AF%94%E8%BE%83%E5%AD%A6%E4%B9%A0/">比较学习</a><span class="category-list-count">6</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/%E5%88%86%E5%B8%83%E5%BC%8F/ZooKeeper/">ZooKeeper</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/ChrisJaunes/categories/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/">单元测试</a><span class="category-list-count">1</span></li></ul> 
            </div>         
        
    </div>
</section>
</div>


<footer class="footer">
	<p class="footer-intro">
		
		@2023 ChrisJaunes.
	</p>
	<p class="footer-intro">
			Powered By <a href="https://github.com/ChrisJaunes" target="_blank"> ChrisJaunes </a> |
			Hexo Powered By <a href="https://hexo.io/zh-cn/" target="_blank">hexo</a> |
			Theme Powered by ChrisJaunes 
	</p>
	<p class="footer-intro">
		<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
		<span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次 &nbsp;|&nbsp;</span>
		<span id="busuanzi_container_site_uv">访客数<span id="busuanzi_value_site_uv"></span>人次&nbsp;|&nbsp;</span>
		<span id="busuanzi_container_page_pv">本文总阅读量<span id="busuanzi_value_page_pv"></span>次</span>
	</p>
</footer>




<div class="extend-tools" id="extend-tools" style="display: none;">
    <ul>
        <li class="tools-returnTop" title="Back to top"><i class="fa fa-angle-double-up"></i></li>
    </ul>
</div>

	</div>


<script src="/ChrisJaunes/js/org/jquery.min.js"></script>


<script src="/ChrisJaunes/js/extend.js"></script>

</body>
</html>